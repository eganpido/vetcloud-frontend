<p-toast position="bottom-right"></p-toast>

<div *ngIf="!viewingDetail" class="fade-in">
    <div class="card shadow-sm p-4">
        <div class="flex justify-content-between align-items-center mb-3">
            <div class="flex align-items-center gap-3">
                <p-button icon="pi pi-arrow-left" severity="secondary" [text]="true" routerLink="/dashboard"></p-button>
                <div class="flex flex-column">
                    <h2 class="m-0 font-bold text-primary text-2xl line-height-2">Customer Directory</h2>
                    <p class="text-500 m-0 text-sm">Guardian Link: Connecting Pets with Dedicated Owners.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <p-button label="Export" icon="pi pi-file-excel" (onClick)="exportToExcel()" styleClass="purple-button"
                    [disabled]="loading">
                </p-button>
                <p-button label="Add Customer" icon="pi pi-plus" (onClick)="openCreate()"
                    [disabled]="loading"></p-button>
            </div>
        </div>

        <div class="mb-4">
            <p-icon-field iconPosition="left">
                <p-inputicon class="pi pi-search"></p-inputicon>
                <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                    placeholder="Search customers..." class="w-full p-inputtext-md" [disabled]="loading" />
            </p-icon-field>
        </div>

        <p-table #dt [value]="loading ? skeletonRows : customers" [paginator]="!loading" responsiveLayout="stack"
            [breakpoint]="'960px'" [rows]="10" [rowsPerPageOptions]="[5, 10, 20]" appendTo="body"
            [paginatorDropdownAppendTo]="'body'"
            [globalFilterFields]="['code', 'customerName', 'customerAdress', 'contactNumber']"
            exportFilename="customer_list" styleClass="p-datatable-customers" [rowHover]="true"
            [showCurrentPageReport]="!loading"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="code">Code <p-sortIcon field="code" *ngIf="!loading"></p-sortIcon></th>
                    <th pSortableColumn="customerName">Customer Name <p-sortIcon field="customerName"
                            *ngIf="!loading"></p-sortIcon></th>
                    <th pSortableColumn="customerAdress">Address <p-sortIcon field="customerAdress"
                            *ngIf="!loading"></p-sortIcon></th>
                    <th pSortableColumn="contactNumber">Contact <p-sortIcon field="contactNumber"
                            *ngIf="!loading"></p-sortIcon></th>
                    <th class="text-center">Status</th>
                    <th class="text-center" style="width: 120px">Action</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-customer>
                <tr *ngIf="loading">
                    <td><p-skeleton width="70%" height="1.2rem"></p-skeleton></td>
                    <td><p-skeleton width="90%" height="1.2rem"></p-skeleton></td>
                    <td><p-skeleton width="85%" height="1.2rem"></p-skeleton></td>
                    <td><p-skeleton width="60%" height="1.2rem"></p-skeleton></td>
                    <td class="text-center"><p-skeleton shape="circle" size="2rem"
                            styleClass="inline-block"></p-skeleton></td>
                    <td class="text-center">
                        <div class="flex gap-2 justify-content-center">
                            <p-skeleton shape="circle" size="2.5rem"></p-skeleton>
                            <p-skeleton shape="circle" size="2.5rem"></p-skeleton>
                        </div>
                    </td>
                </tr>

                <tr *ngIf="!loading" class="customer-row">
                    <td><i class="pi pi-tag mr-2"></i>{{ customer.code }}</td>
                    <td><i class="pi pi-user mr-2"></i>{{ customer.customerName }}</td>
                    <td><i class="pi pi-map-marker text-400 mr-2"></i>{{ customer.customerAdress }}</td>
                    <td><i class="pi pi-phone text-400 mr-2"></i>{{ customer.contactNumber }}</td>
                    <td class="text-center">
                        <p-tag [severity]="customer.isLocked ? 'danger' : 'success'"
                            [value]="customer.isLocked ? 'Locked' : 'Unlocked'" [rounded]="true">
                        </p-tag>
                    </td>
                    <td class="text-center">
                        <div class="flex gap-2 justify-content-center">
                            <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text custom-edit-btn"
                                (click)="viewDetail(customer)" pTooltip="View Details" tooltipPosition="top">
                            </button>
                            <button pButton icon="pi pi-trash"
                                class="p-button-rounded p-button-text p-button-danger custom-delete-btn"
                                (click)="handleDelete(customer)" [disabled]="customer.isLocked"
                                [pTooltip]="customer.isLocked ? 'Locked' : 'Delete'" tooltipPosition="top">
                            </button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr *ngIf="!loading">
                    <td colspan="6" class="empty-state text-center p-5">
                        <i class="pi pi-database text-600 mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                        <div class="text-xl font-medium text-600">No Customers Found</div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<div *ngIf="viewingDetail" class="fade-in">
    <app-customer-detail [customer]="selectedCustomer" [isEditMode]="isEdit" (onBack)="viewingDetail = false"
        (onSave)="handleSave($event)" (onLock)="handleLock($event)" (onUnlock)="handleUnlock($event)">
    </app-customer-detail>
</div>

<p-confirmDialog></p-confirmDialog>